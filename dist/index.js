!function(e){var r={};function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var o in e)t.d(n,o,function(r){return e[r]}.bind(null,o));return n},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=6)}([function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const n=t(16),o=t(17),s=t(18);r.expressErrorLogger=n.errorLogger({transports:[new o.transports.Console,new s({filename:"log/%DATE%-ERROR-EXPRESS.log",datePattern:"YYYY-MM-DD",zippedArchive:!0,maxSize:"10m",maxFiles:"14d"})]}),r.dbErrorLogger=o.createLogger({level:"error",format:o.format.combine(o.format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),o.format.json()),transports:[new o.transports.Console,new s({filename:"log/%DATE%-ERROR-DB.log",datePattern:"YYYY-MM-DD",zippedArchive:!0,maxSize:"10m",maxFiles:"14d"})]}),r.authErrorLogger=o.createLogger({level:"info",format:o.format.combine(o.format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),o.format.json()),transports:[new o.transports.Console,new s({filename:"log/%DATE%-INFO-AUTHFAIL.log",datePattern:"YYYY-MM-DD",zippedArchive:!0,maxSize:"10m",maxFiles:"14d"})]}),r.catchErrorLogger=o.createLogger({level:"error",format:o.format.combine(o.format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),o.format.json()),transports:[new o.transports.Console,new s({filename:"log/%DATE%-CATCHED.log",datePattern:"YYYY-MM-DD",zippedArchive:!0,maxSize:"10m",maxFiles:"14d"})]}),r.clientLogger=o.createLogger({level:"info",format:o.format.combine(o.format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),o.format.json()),transports:[new o.transports.Console,new s({filename:"log/%DATE%-CLIENT.log",datePattern:"YYYY-MM-DD",zippedArchive:!0,maxSize:"10m",maxFiles:"14d"})]})},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});t(20);!function(e){for(var t in e)r.hasOwnProperty(t)||(r[t]=e[t])}(t(21)),r.SERVER_REQUIRED_ENV_KEY_ARRAY=["NODE_ENV","MPIP","CINERINO_API_ENDPOINT","CINERINO_AUTHORIZE_SERVER_DOMAIN","CINERINO_CLIENT_ID","CINERINO_CLIENT_SECRET","CINERINO_EVENT_IDENTIFIER_FACTORYTOUR","CINERINO_EVENT_IDENTIFIER_MYBABYSTAR","AUTH_JWT_SECRET","AUTH_USER_STB_ID","AUTH_USER_STB_PASSWORD","AUTH_USER_ADMIN_ID","AUTH_USER_ADMIN_PASSWORD","CONFIG_STATUS_THRESHOLD_TYPE","CONFIG_STATUS_THRESHOLD_VALUE_CROWDED"]},function(e,r){e.exports=require("express")},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const n=t(19),o=t(0),s=t(1);r.genNewToken=e=>{try{console.log("genNewToken");const r=e.level===s.ENUM_USER_LEVEL.STB?{}:{expiresIn:"1h"};return n.sign({id:e.id,level:e.level},process.env.AUTH_JWT_SECRET,r)}catch(e){throw o.catchErrorLogger.error(`[checkUserAuth][genNewToken] ${e.message}`),e}},r.verifyToken=e=>n.verify(e,process.env.AUTH_JWT_SECRET),r.refreshToken=e=>n.verify(e,process.env.AUTH_JWT_SECRET),r.checkUserAuth=e=>async(t,n,i)=>{let E=null;try{const a=e||{},c=t.query.jwt||t.body.jwt||t.headers.token;try{if(!c)throw new Error("no token access.");try{E=r.verifyToken(c)}catch(e){throw new Error(`invalid token: ${e.message}`)}if(a.isAdminRealm&&E.level!==s.ENUM_USER_LEVEL.ADMIN)throw new Error("permission denied.")}catch(e){return o.authErrorLogger.info(`[checkUserAuth][${t.url}][${t.ip}] ${e.message}`),n.status(401).send("401")}const u=E.exp&&1e3*E.exp-Date.now()<6e5;return n.setHeader("token",u?r.genNewToken(E):c),n.locals.authUserToken=E,i()}catch(e){return o.catchErrorLogger.error(`[checkUserAuth][${t.url}][${t.ip}] ${e.message}`),n.status(500).send("internal server error: process token.")}},r.default=r.checkUserAuth},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const n=t(0);r.errorResponseHandler=(e,r,t,o)=>o.code?t.status(o.code).send(o.message):(n.catchErrorLogger.error(`[${r.originalUrl}] ${o.message}`),t.status(500).send(`[${r.route.path}] internal server error${e?`: ${o.message}`:"."}`))},function(e,r){e.exports=require("fs")},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});t(7);const n=t(8),o=(t(9),t(2)),s=t(10),i=t(11),E=t(12),a=t(13),c=(t(5),t(14)),u=t(0),_=t(3),T=t(22),N=t(1);try{const e=process.env.PORT,r={methods:"GET,HEAD,PUT,PATCH,POST,DELETE",allowedHeaders:["Origin","X-Requested-With","token","Content-Type","Authorization","Accept"],exposedHeaders:["token"],credentials:!0};0;const t=o(),S=n.createServer(t),d=c.createSocketIoServer(S),A=N.SERVER_REQUIRED_ENV_KEY_ARRAY.filter(e=>null==process.env[e]);t.use((e,r,t)=>A.length?r.status(500).send(`[FATAL] server env missing: ${A.join(", ")}`):t()),console.log("required env missing:",A),t.use(i(r)).use(E()).use(s.json()),t.use("/json",_.checkUserAuth(),o.static(N.PATH_DIST_JSON)),t.use("/api",(e,r,t)=>(e.io=d,t()),T.ApiRouter),t.use(a()).use(o.static("./frontend/dist")),t.use(u.expressErrorLogger),S.listen(e),console.log(`[app] server started on port ${e}...`)}catch(e){console.log("[FATAL][app]",e),u.catchErrorLogger.error(`[FATAL][app] ${e.message}`)}},function(e,r){e.exports=require("dotenv")},function(e,r){e.exports=require("http")},function(e,r){e.exports=require("https")},function(e,r){e.exports=require("body-parser")},function(e,r){e.exports=require("cors")},function(e,r){e.exports=require("helmet")},function(e,r){e.exports=require("connect-history-api-fallback")},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const n=t(15),o=t(0),s=t(3),i=t(1);r.createSocketIoServer=e=>{const r=n(e);return r.on(i.ENUM_SOCKETIO_EVENT_NAMES.CONNECTION,e=>{e.on(i.ENUM_SOCKETIO_EVENT_NAMES.SUBSCRIBE,r=>{try{try{s.verifyToken(r.jwt)}catch(t){return e.emit(i.ENUM_SOCKETIO_EVENT_NAMES.CONNECTION_REJECTED,t.message),e.disconnect(),o.authErrorLogger.error(`[socketIo][${i.ENUM_SOCKETIO_EVENT_NAMES.SUBSCRIBE}][${r.dataTargetArray.join(", ")}] auth failed: ${t.message}`)}return r.dataTargetArray.forEach(()=>{e.join(r.dataTargetArray)}),e.emit(i.ENUM_SOCKETIO_EVENT_NAMES.SUBSCRIBE_GRANTED,r.dataTargetArray)}catch(r){return e.emit(i.ENUM_SOCKETIO_EVENT_NAMES.CONNECTION_REJECTED,r.message),o.catchErrorLogger.error(`[socketIo][${i.ENUM_SOCKETIO_EVENT_NAMES.SUBSCRIBE}] ${r.message}`)}})}),r.emitData=(e,t)=>{try{r.to(e).emit(i.ENUM_SOCKETIO_EVENT_NAMES.DATA_UPDATED,{[e]:t})}catch(r){o.catchErrorLogger.error(`[socketIo][emitData][${e}] ${r.message}`)}},r}},function(e,r){e.exports=require("socket.io")},function(e,r){e.exports=require("express-winston")},function(e,r){e.exports=require("winston")},function(e,r){e.exports=require("winston-daily-rotate-file")},function(e,r){e.exports=require("jsonwebtoken")},function(e,r){e.exports=require("ts-transformer-keys")},function(e,r,t){"use strict";var n,o,s;Object.defineProperty(r,"__esModule",{value:!0}),r.PORT_LOCAL_SERVER=3082,r.LOCAL_API_URL=`https://localhost:${r.PORT_LOCAL_SERVER}`,r.PORT_LOCAL_FRONT=3029,r.LOCAL_FRONT_URL=`https://localhost:${r.PORT_LOCAL_FRONT}`,r.PATH_DIST_JSON="./dist/jsondata",r.PATH_API="/api",r.PATH_JSON="/json",r.PATH_SOCKET="/socket.io",function(e){e.PERCENTAGE="PERCENTAGE",e.NUMBER="NUMBER"}(r.ENUM_CONFIG_STATUS_THRESHOLD_TYPE||(r.ENUM_CONFIG_STATUS_THRESHOLD_TYPE={})),function(e){e.CAPABLE="circle",e.CROWDED="triangle",e.SOLDOUT="cross"}(r.ENUM_TIKECT_STATUS||(r.ENUM_TIKECT_STATUS={})),function(e){e.STB="STB",e.ADMIN="ADMIN"}(r.ENUM_USER_LEVEL||(r.ENUM_USER_LEVEL={})),function(e){e.FURIFURI="FURIFURI",e.CRUNCH="CRUNCH",e.ATHLETIC="ATHLETIC"}(n=r.ENUM_LOCAL_EVENT_IDS||(r.ENUM_LOCAL_EVENT_IDS={})),function(e){e.MYBABYSTAR="MYBABYSTAR",e.FACTORYTOUR="FACTORYTOUR"}(o=r.ENUM_TICKET_EVENT_IDS||(r.ENUM_TICKET_EVENT_IDS={})),r.ENUM_EVENT_IDS=Object.assign({},o,n),r.EVENT_NAME_DIC={[r.ENUM_EVENT_IDS.CRUNCH]:"ベビースターチョコクランチ作り体験",[r.ENUM_EVENT_IDS.FURIFURI]:"フリフリベビースター体験",[r.ENUM_EVENT_IDS.ATHLETIC]:"超ドデカイアスレチック",ALL:"全て"},function(e){e.MESSAGE="MESSAGE",e.TIME="TIME"}(r.ENUM_LOCAL_EVENT_STATUS_TYPE||(r.ENUM_LOCAL_EVENT_STATUS_TYPE={})),function(e){e.SUBSCRIBE="subscribe",e.SUBSCRIBE_GRANTED="subscribeGranted",e.CONNECTION_REJECTED="connenctionRejected",e.DATA_UPDATED="dataUpdated",e.CONNECT="connect",e.CONNECTION="connection",e.CONNECTED="connected",e.DISCONNECTED="disconnected"}(r.ENUM_SOCKETIO_EVENT_NAMES||(r.ENUM_SOCKETIO_EVENT_NAMES={})),function(e){e.INPREPARATION="準備中",e.CLOSE="お休み",e.END="本日終了"}(s=r.ENUM_EVENT_STATUSSTRING||(r.ENUM_EVENT_STATUSSTRING={}));r.EVENT_STATUSSTRING_VALUE_ARRAY=[s.INPREPARATION,...((e,r,t)=>Array.from({length:(r-e)/t+1},(r,n)=>e+n*t))(0,120,5),s.CLOSE,s.END]},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const n=t(2),o=t(23),s=t(28),i=t(29),E=n.Router();E.use("/auth",s.authApiRouter),E.use("/status",o.statusApiRouter),E.use("/util",i.utilApiRouter),E.use((e,r)=>r.status(404).send("404")),r.ApiRouter=E},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const n=t(24),o=t(2),s=t(5),i=t(3),E=t(4),a=t(25),c=t(1),u=Object.keys(process.env).reduce((e,r)=>{const t=/^CINERINO_EVENT_IDENTIFIER_(.*)/.exec(r);return t&&t[1]&&(e[t[1]]=process.env[r]),e},{}),_=Object.keys(u).reduce((e,r)=>(e[u[r]]=r,e),{}),T=o.Router();T.get("/tickets",i.checkUserAuth({isAdminRealm:!1}),async(e,r)=>{try{let t=null;try{if(!e.query.startFrom||!e.query.startThrough||!e.query.requiredEventIdentifierKeyArray.length)throw new Error("parameter missing.");t=e.query.requiredEventIdentifierKeyArray.map(e=>{if(!u[e])throw new Error(`unexpected identifier: ${e} .`);return u[e]})}catch(e){return r.status(400).send(`invalid request : ${e.message}`)}return r.json((await a.cinerinoSearchScreeningEvents({workPerformedIdentifiers:t,startFrom:e.query.startFrom,startThrough:e.query.startThrough,locationBranchCode:e.query.locationBranchCode})).data.reduce((e,r)=>{if(-1===t.indexOf(r.workPerformed.identifier))return e;const n=_[r.workPerformed.identifier];return e[n]=e[n]||[],e[n].push(r),e},{}))}catch(t){return console.log("[catched][fetchTicketsStatusContoller]",t),E.errorResponseHandler(!0,e,r,t)}}),T.post("/events/init/:name",i.checkUserAuth({isAdminRealm:!0}),async(e,r)=>{const t=e.params.name;try{if(!(t&&t in c.ENUM_LOCAL_EVENT_IDS))return r.status(400).send("invalid target name.");const o={name:t,type:c.ENUM_LOCAL_EVENT_STATUS_TYPE.TIME,statusString:10,updateAt:Date.now(),updateAtString:n().format("YYYY/MM/DD HH:mm:ss")};return s.writeFileSync(`${c.PATH_DIST_JSON}/${t}.json`,JSON.stringify(o),{encoding:"utf-8"}),e.io.emitData(t,o),r.json(o)}catch(t){return E.errorResponseHandler(!0,e,r,t)}}),T.put("/events/update/:name",i.checkUserAuth({isAdminRealm:!0}),async(e,r)=>{const t=e.params.name;try{try{if(!(t&&t in c.ENUM_LOCAL_EVENT_IDS&&e.body.name===t))throw new Error("invalid name.");if(-1===c.EVENT_STATUSSTRING_VALUE_ARRAY.indexOf(e.body.statusString))throw new Error(`invalid request: ${JSON.stringify(e.body)}`)}catch(e){return r.status(400).send(e.message)}const o={name:t,type:"string"==typeof e.body.statusString?c.ENUM_LOCAL_EVENT_STATUS_TYPE.MESSAGE:c.ENUM_LOCAL_EVENT_STATUS_TYPE.TIME,statusString:e.body.statusString,updateAt:Date.now(),updateAtString:n().format("YYYY/MM/DD HH:mm:ss")};return s.writeFileSync(`${c.PATH_DIST_JSON}/${t}.json`,JSON.stringify(o),{encoding:"utf-8"}),e.io.emitData(t,o),r.json(o)}catch(t){return E.errorResponseHandler(!0,e,r,t)}}),r.statusApiRouter=T},function(e,r){e.exports=require("dayjs")},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const n=t(26),o=t(27),s=t(0);r.getCinerinoAuthedOptions=()=>new Promise(async(e,r)=>{try{const t={endpoint:process.env.CINERINO_API_ENDPOINT,auth:new o.auth.ClientCredentials({domain:process.env.CINERINO_AUTHORIZE_SERVER_DOMAIN,clientId:process.env.CINERINO_CLIENT_ID,clientSecret:process.env.CINERINO_CLIENT_SECRET,state:n.v1(),scopes:[]})};return t.auth.setCredentials({access_token:await t.auth.getAccessToken()}),e(t)}catch(e){const t=`[cinerino][getCinerinoAuthedOptions] ${e.message}`;return s.catchErrorLogger.error(t),r(new Error(t))}}),r.cinerinoSearchScreeningEvents=e=>new Promise(async(t,n)=>{let i;try{i=await r.getCinerinoAuthedOptions()}catch(e){return n(e)}try{return t(await new o.service.Event(i).searchScreeningEvents({typeOf:o.factory.chevre.eventType.ScreeningEvent,eventStatuses:[o.factory.chevre.eventStatusType.EventScheduled],superEvent:{workPerformedIdentifiers:e.workPerformedIdentifiers,locationBranchCodes:[e.locationBranchCode]},startFrom:e.startFrom,startThrough:e.startThrough}))}catch(e){const r=`[cinerino][cinerinoSearchScreeningEvents] ${e.message}`;return s.catchErrorLogger.error(r),n(new Error(r))}})},function(e,r){e.exports=require("uuid")},function(e,r){e.exports=require("@cinerino/api-nodejs-client")},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const n=t(2),o=t(3),s=t(0),i=t(4),E=t(1),a=n.Router();a.post("/checkToken",o.checkUserAuth(),(e,r)=>r.json({user:r.locals.authUserToken})),a.post("/login",(e,r)=>{try{const t=e.body.loginId,n=e.body.password,a=t===process.env.AUTH_USER_ADMIN_ID,c=t===process.env.AUTH_USER_STB_ID,u=a?process.env.AUTH_USER_ADMIN_PASSWORD:process.env.AUTH_USER_STB_PASSWORD;if(!a&&!c||n!==u)return s.authErrorLogger.info(`[login][${e.ip}] ${t}:${u}`),r.status(401).send("login failed: confirm id & password.");const _=o.genNewToken({id:t,level:a?E.ENUM_USER_LEVEL.ADMIN:E.ENUM_USER_LEVEL.STB});return r.setHeader("token",_),r.json({user:{loginId:t,isAdmin:a},token:_})}catch(t){return i.errorResponseHandler(!0,e,r,t)}}),r.authApiRouter=a},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const n=t(2),o=t(3),s=t(0),i=t(4),E=t(1),a=n.Router();a.post("/getEnvConfig",o.checkUserAuth(),(e,r)=>r.json(E.SERVER_REQUIRED_ENV_KEY_ARRAY.filter(e=>0===e.indexOf("CONFIG_")).reduce((e,r)=>(e[r]=process.env[r],e),{}))),a.post("/logger",(e,r)=>{try{return s.clientLogger.info(`[${e.ip}]${e.body.message}`),r.json({success:!0})}catch(t){return i.errorResponseHandler(!0,e,r,t)}}),r.utilApiRouter=a}]);